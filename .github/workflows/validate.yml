name: Validate

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  check:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 2

      - name: Check if should run
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "Current commit: $CURRENT_SHA"

          # Skip if commit is less than 5 minutes old (still editing)
          COMMIT_TIME=$(git log -1 --format=%ct)
          NOW=$(date +%s)
          COMMIT_AGE=$((NOW - COMMIT_TIME))

          if [ $COMMIT_AGE -lt 300 ]; then
            echo "::notice title=Validation Skipped::Commit is ${COMMIT_AGE}s old (< 5min), still being edited"
            exit 78
          fi

          # Check if this commit already has a validation status
          VALIDATED=$(gh api repos/${{ github.repository }}/commits/$CURRENT_SHA/statuses \
            --jq '.[] | select(.context == "validation/content") | .state' 2>/dev/null | head -1 || echo "")

          if [ -n "$VALIDATED" ]; then
            echo "::notice title=Validation Skipped::Commit already validated (result: $VALIDATED)"
            exit 78
          fi

          echo "Will validate commit $CURRENT_SHA"
          echo "should_run=true" >> $GITHUB_OUTPUT

  validate:
    needs: check
    if: always() && (github.event_name != 'schedule' || needs.check.outputs.should_run == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || 'staging' }}
          fetch-depth: 2

      - name: Get commit SHA
        id: sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate content
        id: validate
        run: |
          npx lens-content-processor@latest . --output validation-result.json
          
          # Check for errors and format output
          ERROR_COUNT=$(jq '.errors | length' validation-result.json)
          echo "Found $ERROR_COUNT validation issues"
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo ""
            echo "## Validation Errors"
            echo ""
            
            # Output errors as GitHub annotations
            jq -r '.errors[] | "::error file=\(.file),line=\(.line // 1)::\(.message)\(if .suggestion then " (" + .suggestion + ")" else "" end)"' validation-result.json
            
            echo ""
            echo "---"
            jq -r '.errors[] | "- **\(.file):\(.line // "?")** - \(.message)"' validation-result.json
            
            exit 1
          fi
          
          echo "âœ“ All content validated successfully"

      - name: Record validation result
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA=${{ steps.sha.outputs.sha }}
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            STATE="success"
            DESC="Validation passed"
          else
            STATE="failure"
            DESC="Validation failed"
          fi
          
          gh api repos/${{ github.repository }}/statuses/$SHA \
            -f state="$STATE" \
            -f context="validation/content" \
            -f description="$DESC" || echo "Failed to set status"
